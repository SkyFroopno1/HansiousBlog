
<!DOCTYPE html>
<html lang="en ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexo || Nginx简单应用及配置模板</title>
    <meta name="author" content="John Doe">
    <meta name="description" content=" ">
    <meta name="keywords" content=" ">
    <link rel="icon" href="/images/avatar.png">
    <link rel="stylesheet" href="/css/antd.min.css">
    
    <link rel="stylesheet" href="/css/maiden-theme.css">
    
    <script src="/js/vue.js"></script>
    <script src="/js/antd.min.js"></script>
<meta name="generator" content="Hexo 5.4.2"></head>

<body>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#a3ddfb; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>加载过慢请开启缓存(浏览器默认开启)</p>
                    <div>
                        <img src="/dancingkitty.gif" alt="loading">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                     
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Hexo</span>
        </a>
        
        <a href="/">
            <span>
                <a-icon type="home" theme="filled" />
            </span>
            <span>home</span>
        </a>
        
        <a href="/about">
            <span>
                <a-icon type="idcard" theme="filled" />
            </span>
            <span>about</span>
        </a>
        
        <a href="/archives">
            <span>
                <a-icon type="folder" theme="filled" />
            </span>
            <span>archives</span>
        </a>
        
        <a href="/like/categories">
            <span>
                <a-icon type="book" theme="filled" />
            </span>
            <span>categories</span>
        </a>
        
        <a href="/like/tags">
            <span>
                <a-icon type="tags" theme="filled" />
            </span>
            <span>tags</span>
        </a>
        
        <a target="_blank" rel="noopener" href="https://en.korilin.com">
            <span>
                <a-icon type="compass" theme="filled" />
            </span>
            <span>英文博客</span>
        </a>
        
    </div>

    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div :class="'title'" @click="menu_show=!menu_show">
            <span style="margin-right: 10px;">
                <a-icon type="appstore" theme="filled" />
            </span>
            <span>Hexo</span>
        </div>
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="home" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="idcard" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">about</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="folder" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">archives</div>
                </div>
            </a>
            
            <a href="/like/categories">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="book" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">categories</div>
                </div>
            </a>
            
            <a href="/like/tags">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="tags" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">tags</div>
                </div>
            </a>
            
            <a target="_blank" rel="noopener" href="https://en.korilin.com">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="compass" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">英文博客</div>
                </div>
            </a>
            
        </div>
        <div class="curtain" v-show="menu_show"></div>
    </div>

</nav>
                </div>

                <div id="main">
                     
<link rel="stylesheet" href="/css/post-body.css">
<div class="article">
    <div>
        <h1>Nginx简单应用及配置模板 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <a-icon type="calendar" theme="filled" />
            </span>
            2021/5/1
        </span>

        

        

        <span class="tags">
            <span class="icon">
                <a-icon type="tags" theme="filled" />
            </span>
            
            <span class="tag">
                
                <a href="/tags/运维" style=color:#00bcd4>
                    运维
                </a>
            </span>
            
        </span>
        
    </div>

    <div class="content" v-pre>
        <h1 id="Nginx概述"><a href="#Nginx概述" class="headerlink" title="Nginx概述"></a>Nginx概述</h1><p>Nginx (engine x)是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务</p>
<h1 id="Nginx常用命令"><a href="#Nginx常用命令" class="headerlink" title="Nginx常用命令"></a>Nginx常用命令</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx <span class="token comment">#启动</span>
./nginx -s stop   <span class="token comment"># 停止</span>
./nginx -s quit   <span class="token comment"># 安全退出</span>
./nginx -s reload <span class="token comment"># 重新加载配置文件</span>
<span class="token function">ps</span> auxlgrep nginx <span class="token comment"># 查看nginx进程</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="Nginx语法匹配规则"><a href="#Nginx语法匹配规则" class="headerlink" title="Nginx语法匹配规则"></a>Nginx语法匹配规则</h1><p>语法规则： location [=|<del>|</del>*|^~] /uri/ { … }</p>
<ul>
<li>= 开头表示精确匹配</li>
<li>^~ 开头表示uri以某个常规字符串开头，理解为匹配 url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。</li>
<li>~ 开头表示区分大小写的正则匹配</li>
<li>~* 开头表示不区分大小写的正则匹配</li>
<li>!~ 和 !~*分别为区分大小写不匹配及不区分大小写不匹配 的正则</li>
<li>/ 通用匹配，任何请求都会匹配到。</li>
</ul>
<p>多个location配置的情况下匹配顺序为（参考资料而来，还未实际验证，试试就知道了，不必拘泥，仅供参考）：首先匹配 =，其次匹配^~, 其次是按文件中顺序的正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</p>
<p>例子，有如下匹配规则：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">location <span class="token operator">=</span> / <span class="token punctuation">&#123;</span>    <span class="token comment"># 精确匹配，必须是127.0.0.1/</span>

<span class="token comment">#规则A</span>

<span class="token punctuation">&#125;</span>

location <span class="token operator">=</span> /login <span class="token punctuation">&#123;</span>    <span class="token comment"># 精确匹配，必须是127.0.0.1/login</span>

<span class="token comment">#规则B</span>

<span class="token punctuation">&#125;</span>

location ^~ /static/ <span class="token punctuation">&#123;</span>    <span class="token comment"># 非精确匹配，并且不区分大小写，比如127.0.0.1/static/js.</span>

<span class="token comment">#规则C</span>

<span class="token punctuation">&#125;</span>

location ~ <span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>    <span class="token comment"># 区分大小写，以gif,jpg,js结尾</span>

<span class="token comment">#规则D</span>

<span class="token punctuation">&#125;</span>

location ~* <span class="token punctuation">\</span>.png$ <span class="token punctuation">&#123;</span>     <span class="token comment"># 不区分大小写，匹配.png结尾的</span>

<span class="token comment">#规则E</span>

<span class="token punctuation">&#125;</span>

location <span class="token operator">!</span>~ <span class="token punctuation">\</span>.xhtml$ <span class="token punctuation">&#123;</span>   <span class="token comment"># 区分大小写，匹配不已.xhtml结尾的</span>

<span class="token comment">#规则F</span>

<span class="token punctuation">&#125;</span>

location <span class="token operator">!</span>~* <span class="token punctuation">\</span>.xhtml$ <span class="token punctuation">&#123;</span>

<span class="token comment">#规则G</span>

<span class="token punctuation">&#125;</span>

location / <span class="token punctuation">&#123;</span>  <span class="token comment"># 什么都可以</span>

<span class="token comment">#规则H</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么产生的效果如下：</p>
<ul>
<li>访问根目录/， 比如<a target="_blank" rel="noopener" href="http://localhost/">http://localhost/</a> 将匹配规则A</li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/login">http://localhost/login</a> 将匹配规则B，<a target="_blank" rel="noopener" href="http://localhost/register">http://localhost/register</a> 则匹配规则H</li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/static/a.html">http://localhost/static/a.html</a> 将匹配规则C</li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/a.gif">http://localhost/a.gif</a>, <a target="_blank" rel="noopener" href="http://localhost/b.jpg">http://localhost/b.jpg</a> 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用， 而 <a target="_blank" rel="noopener" href="http://localhost/static/c.png">http://localhost/static/c.png</a> 则优先匹配到 规则C</li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/a.PNG">http://localhost/a.PNG</a> 则匹配规则E， 而不会匹配规则D，因为规则E不区分大小写。</li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/a.xhtml">http://localhost/a.xhtml</a> 不会匹配规则F和规则G，<a target="_blank" rel="noopener" href="http://localhost/a.XHTML%E4%B8%8D%E4%BC%9A%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99G%EF%BC%8C%E5%9B%A0%E4%B8%BA%E4%B8%8D%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99%E3%80%82%E8%A7%84%E5%88%99F%EF%BC%8C%E8%A7%84%E5%88%99G%E5%B1%9E%E4%BA%8E%E6%8E%92%E9%99%A4%E6%B3%95%EF%BC%8C%E7%AC%A6%E5%90%88%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99%E4%BD%86%E6%98%AF%E4%B8%8D%E4%BC%9A%E5%8C%B9%E9%85%8D%E5%88%B0%EF%BC%8C%E6%89%80%E4%BB%A5%E6%83%B3%E6%83%B3%E7%9C%8B%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E4%B8%AD%E5%93%AA%E9%87%8C%E4%BC%9A%E7%94%A8%E5%88%B0%E3%80%82">http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到。</a></li>
<li>访问 <a target="_blank" rel="noopener" href="http://localhost/category/id/1111">http://localhost/category/id/1111</a> 则最终匹配到规则H，因为以上规则都不匹配，这个时候应该是nginx转发请求给后端应用服务器，比如FastCGI（php），tomcat（jsp），nginx作为方向代理服务器存在。</li>
</ul>
<p>==注意:如果uri包含正则表达式，则必须要有~ 或者 ~*标识。==</p>
<blockquote>
<p>实际中常用</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#这里是直接转发给后端应用服务器了，也可以是一个静态首页</span>

<span class="token comment"># 第一个必选规则</span>

location <span class="token operator">=</span> / <span class="token punctuation">&#123;</span>

proxy_pass http://tomcat:8080/index

<span class="token punctuation">&#125;</span>

<span class="token comment"># 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项</span>

<span class="token comment"># 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</span>

location ^~ /static/ <span class="token punctuation">&#123;</span>

root /webroot/static/<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

location ~* <span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>

root /webroot/res/<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">#第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span>

<span class="token comment">#非静态文件请求就默认是动态请求，自己根据实际把握</span>

<span class="token comment">#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了</span>

location / <span class="token punctuation">&#123;</span>

proxy_pass http://tomcat:8080/

<span class="token punctuation">&#125;</span>

<span class="token comment">#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。</span>

<span class="token comment">#这里是直接转发给后端应用服务器了，也可以是一个静态首页</span>

<span class="token comment"># 第一个必选规则</span>

location <span class="token operator">=</span> / <span class="token punctuation">&#123;</span>

proxy_pass http://tomcat:8080/index

<span class="token punctuation">&#125;</span>

<span class="token comment"># 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项</span>

<span class="token comment"># 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</span>

location ^~ /static/ <span class="token punctuation">&#123;</span>

root /webroot/static/<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

location ~* <span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>

root /webroot/res/<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">#第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span>

<span class="token comment">#非静态文件请求就默认是动态请求，自己根据实际把握</span>

<span class="token comment">#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了</span>

location / <span class="token punctuation">&#123;</span>

proxy_pass http://tomcat:8080/

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="反向代理配置"><a href="#反向代理配置" class="headerlink" title="反向代理配置"></a>反向代理配置</h1><p>配置文件结构：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span>http 配置<span class="token punctuation">)</span>
	
	server<span class="token punctuation">&#123;</span>
		listen  <span class="token number">80</span><span class="token punctuation">;</span>
		server_name localhost<span class="token punctuation">;</span>
		<span class="token comment"># 代理</span>
		location / <span class="token punctuation">&#123;</span>
			<span class="token comment"># xxxx</span>
			root 
			index
			proxy_pass <span class="token comment">#代理服务</span>
		<span class="token punctuation">&#125;</span>
		
		location / <span class="token punctuation">&#123;</span>
			<span class="token comment"># xxxx</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
	server<span class="token punctuation">&#123;</span>
		listen  <span class="token number">443</span><span class="token punctuation">;</span>
		server_name localhost<span class="token punctuation">;</span>
		<span class="token comment"># 代理</span>
	<span class="token punctuation">&#125;</span>
	<span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="负载均衡配置"><a href="#负载均衡配置" class="headerlink" title="负载均衡配置"></a>负载均衡配置</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span>http 配置<span class="token punctuation">)</span>
	
	upstream name<span class="token punctuation">&#123;</span>
		<span class="token comment"># 负载均衡策略</span>
		<span class="token punctuation">[</span>轮询<span class="token punctuation">(</span>default<span class="token punctuation">)</span> <span class="token operator">|</span> weight <span class="token operator">|</span> ip_hash <span class="token operator">|</span> fair<span class="token punctuation">]</span>
		<span class="token comment"># 负载均衡服务器列表</span>
		server IP:Port weight <span class="token operator">=</span> x<span class="token punctuation">;</span>
		<span class="token punctuation">..</span>.
	<span class="token punctuation">&#125;</span>
	
	server<span class="token punctuation">&#123;</span>
		listen  <span class="token number">80</span><span class="token punctuation">;</span>
		server_name localhost<span class="token punctuation">;</span>
		<span class="token comment"># 代理</span>
		location / <span class="token punctuation">&#123;</span>
			<span class="token comment"># xxxx</span>
			root 
			index
			<span class="token comment"># 代理服务</span>
			proxy_pass http://<span class="token punctuation">[</span>upstream起的name<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
	<span class="token punctuation">&#125;</span>
	
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>分配策略：</p>
<ul>
<li>轮询(默认)：每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除</li>
<li>weight：weight代表权重，默认值为1，权重越高，被分配的客户端越多</li>
<li>ip_hash：每个请求按访问ip的hash结果分配，这样每个访客固定访问同一台后端服务器</li>
<li>fair(第三方)：按后端服务器的响应时间来分配请求，响应时间短的优先分配。</li>
</ul>
<h1 id="动静分离配置"><a href="#动静分离配置" class="headerlink" title="动静分离配置"></a>动静分离配置</h1><p>Nginx动静分离简单来说就是把动态跟静态请求分开,不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成使用Nginw.处理静态页面，Tomcat处理动态页面。动静分离从目前实现角度来讲大致分为两种：</p>
<ol>
<li>一种是纯粹把静态文件独立成单独的域名,放在独立的服务器上,也是目前主流推崇的方案;</li>
<li>另外一种方法就是动态跟静态文件混合在一起发布，通过nginx来分开。</li>
</ol>
<p>通过location指定不同的后缀名实现不同的请求转发。通过expires参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。具体Expires定义:是给一个资源设定一个过期时间,也就是说无需去服务端验证,直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。(如果经常更新的文件，不建议使用Expires来缓存)，我这里设置3d，表示在这3天之内访问这个URL，发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码304，如果有修改，则直接从服务器重新下载，返回状态码200。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">http<span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span>http 配置<span class="token punctuation">)</span>
	
	server<span class="token punctuation">&#123;</span>
		listen  <span class="token number">80</span><span class="token punctuation">;</span>
		server_name localhost<span class="token punctuation">;</span>
		<span class="token comment"># 代理</span>
		location /规则1 <span class="token punctuation">&#123;</span>
			<span class="token comment"># xxxx</span>
			root 
			index
			<span class="token comment"># 代理服务</span>
			proxy_pass http://<span class="token punctuation">[</span>upstream起的name<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		location /规则2 <span class="token punctuation">&#123;</span>
			<span class="token comment"># xxxx</span>
			root 
			index
			<span class="token comment"># 代理服务</span>
			proxy_pass http://<span class="token punctuation">[</span>upstream起的name<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
	<span class="token punctuation">&#125;</span>
	
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h1><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220109203922527.png" alt="image-20220109203922527"></p>
<ul>
<li><p>需要两台Nginx服务器</p>
</li>
<li><p>需要Keepalived</p>
<ul>
<li><p>```bash<br>yum install keepalived -y</p>
<pre class="line-numbers language-none"><code class="language-none">
- 在etc里面生成目录keepalived，有文件keepalived.conf

  &#96;&#96;&#96;shell
  # 全局配置
  glocal_defs &#123;
  	notification_email&#123;
  		acassen@firewall.loc
  		failover@firewall.loc
  		sysadmin@firewall.loc
  	&#125;
  	notification_email_from Alexandre.Cassen@firewall.loc
  	smtp_server 主机IP
  	smtp_counnect_timeout 30 
  	router_id 主机名 # 访问到主机 &#x2F;etc&#x2F;hosts中编辑
  &#125;
  
  # 检测脚本配置
  vrrp_script chk_http_port &#123;
  	script &quot;&#x2F;usr&#x2F;local&#x2F;src&#x2F;nginx_check.sh&quot;
  	interval 2 # 检测脚本执行的间隔
  	weight 2 # 权重，设置当前服务器的一个权重
  &#125;
  
  # 虚拟IP的配置
  vrrp_instance VI_1&#123;
  	state MASTER # 备份服务器上讲MASTER换成BACKUP
  	interface ens33 # 网卡
  	virtual_router_id 51 # 主备机的virtual_router id 必须相同
  	priority 100 # 主备机取不同的优先级，主机值较大，备份机较小
  	advert_int 1 # 时间间隔
  	authtication &#123;
  		auth_type PASS
  		auth_pass 1111
  	&#125;
  	viretual_ipaddress &#123;
  		# VRRP H虚拟地址
  	&#125;
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>检测脚本nginx_check.sh</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># !/bin/bash</span>
A <span class="token operator">=</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx -no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token variable">$A</span> -eq <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
	/usr/local/nginx/sbin/nginx
	<span class="token function">sleep</span> <span class="token number">2</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header <span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span> -eq <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
		<span class="token function">killall</span> keepalived
    <span class="token keyword">fi</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>需要虚拟ip</p>
</li>
</ul>
<h1 id="Nginx原理"><a href="#Nginx原理" class="headerlink" title="Nginx原理"></a>Nginx原理</h1><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220109213113322.png" alt="image-20220109213113322"></p>
<p>两个进程：worker&amp;master</p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20220109213215084.png" alt="image-20220109213215084"></p>
<p>多个worker使用的是争抢机制</p>
<blockquote>
<p>一个 master 和多个 woker 有好处</p>
</blockquote>
<ol>
<li>可以使用 nginx –s reload 热部署，利用 nginx 进行热部署操作</li>
<li>每个 woker 是独立的进程，如果有其中的一个 woker 出现问题，其他 woker 独立的，继续进行争抢，实现请求过程，不会造成服务中断</li>
</ol>
<blockquote>
<p>设置多少个 woker 合适</p>
</blockquote>
<p>Nginx和Redis类似都采用了IO多路复用机制，每个worker都是一个独立的进程，但每个进程里面只有一个主线程，通过异步非阻塞的方式来处理请求。每个worker的线程可以把一个CPU的i性能发挥到极致。所以worker数和服务器的CPU数相等是最合适的。设少了会浪费CPU，多了会导致CPU频繁的上下文切换</p>
<blockquote>
<p>连接数 worker_connection</p>
</blockquote>
<p>这个值表示每个worker进程所能建立连接的最大值，所以，一个Nginx能建立的最大连接数，应该是worker_connections * worker_processes。这里所说的是最大连接数。</p>
<ul>
<li>对于HTTP请求本地资源来说，能够支持的最大并发数量是 worker_connections * worker_processses，</li>
<li>如果是支持http1.1 的浏览器每次访问要占两个连接，所以普通的静态访问最大并发数是: worker_connections * worker_processes / 2</li>
<li>如果是HTTP作为反向代理来说，最大并发数量应该是worker_connection * worker_processes / 4</li>
</ul>
<p>因此作为反向代理服务器，每个并发会与客户端的连接和与后端服务的连接，会占用两个连接</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="[解决办法]"></a>[解决办法]</h1><h2 id="阿里云服务器80端口被占用解决方案"><a href="#阿里云服务器80端口被占用解决方案" class="headerlink" title="阿里云服务器80端口被占用解决方案"></a>阿里云服务器80端口被占用解决方案</h2><p>fuser -k 80/tcp命令停止阿里云的占用进程</p>

    </div>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <div id="comment">
        <div id="gitalk-container">
        </div>
    </div>
    
</div>
                     
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2018 - 2022 Hexo
            <span class="footer-icon">
                <a-icon type="flag" theme="filled" /></span>
            @John Doe
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div>
        
    </div>

</footer>

<script src="/js/highlight.min.js"></script>
<script src="/js/particle.js"></script>
                </div>
            </div>
        </transition>
    </div>

    <script>
    new Vue({
        el: "#layout",
        data: {
            show_page: false,
            onload_menu: false,
            menu_show: false,
            card_top: 100
        },
        created: function () {
            var that = this
            window.onload = function () {
                that.show_page = true
                document.getElementById("loadcontent").style.opacity = 0
                setTimeout(function () {
                    document.getElementById("loadleft").style.width = 0
                    document.getElementById("loadright").style.width = 0
                }, 300)
                setTimeout(function () {
                    document.getElementById("loading").style = "display:none"
                }, 600)
            }
        },
        mounted: function () {
            var that = this
            window.addEventListener('scroll', function (e) {
                that.menu_show = false
            })
        },
        methods: {
            home_click: function () {
                window.scrollTo({
                    top: window.innerHeight - 80,
                    behavior: "smooth",
                });
            }
        }
    })
</script>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'hexo-theme-particle',      // The repository of store comments,
        owner: 'korilin',
        admin: ['korilin'],
        language: 'en',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: true  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>

</body>

</html>